<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FisioGest Pro v2.0 - Sistema Completo</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 400px;
        }

        .login-box h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        /* Main App */
        .app-container {
            display: none;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        /* Navigation */
        .nav-tabs {
            background: #f0f0f0;
            display: flex;
            overflow-x: auto;
            border-bottom: 2px solid #ddd;
        }

        .nav-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #e0e0e0;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
            border-bottom-color: #667eea;
        }

        /* Content */
        .content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .card h3 {
            color: #555;
            margin: 20px 0 15px 0;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102,126,234,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-secondary { background: #718096; color: white; }
        .btn-info { background: #4299e1; color: white; }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background: #f7f7f7;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 700px;
            padding: 30px;
            border-radius: 10px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .close {
            font-size: 30px;
            color: #999;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }

        .stat-label {
            margin-top: 5px;
            opacity: 0.9;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e6f4ff;
            border-left: 4px solid #1890ff;
        }

        .alert-success {
            background: #f6ffed;
            border-left: 4px solid #52c41a;
        }

        .alert-error {
            background: #ffebe6;
            border-left: 4px solid #ff4d4f;
        }

        /* Badge */
        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .badge-success { background: #c6f6d5; color: #22543d; }
        .badge-warning { background: #feebc8; color: #744210; }
        .badge-danger { background: #fed7d7; color: #742a2a; }
        .badge-info { background: #e6f4ff; color: #0050b3; }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .notification.success {
            background: #52c41a;
            color: white;
        }

        .notification.error {
            background: #ff4d4f;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h2>üè• FisioGest Pro v2.0</h2>
            
            <div id="loginError" class="alert alert-error" style="display: none;"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" id="loginEmail" required value="admin@fisiogest.es">
                </div>
                
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" class="form-control" id="loginPassword" required value="admin123">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Iniciar Sesi√≥n
                </button>
            </form>
            
            <div style="margin-top: 20px; text-align: center; color: #666; font-size: 12px;">
                Usuario por defecto: admin@fisiogest.es / admin123
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="mainApp">
        <div class="header">
            <h1>üè• FisioGest Pro</h1>
            <div class="user-info">
                <span id="userName">Usuario</span>
                <span class="user-badge" id="userType">Tipo</span>
                <button class="btn btn-secondary btn-sm" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection('pacientes')">üë• Pacientes</button>
            <button class="nav-tab" onclick="showSection('citas')">üïê Citas</button>
            <button class="nav-tab" onclick="showSection('actos')">üíä Actos y Bonos</button>
            <button class="nav-tab" onclick="showSection('usuarios')">üë®‚Äç‚öïÔ∏è Usuarios</button>
            <button class="nav-tab" onclick="showSection('config')">‚öôÔ∏è Configuraci√≥n</button>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <div id="dashboard" class="section active">
                <div class="card">
                    <h2>Dashboard</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statPacientes">0</div>
                            <div class="stat-label">Pacientes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statCitasHoy">0</div>
                            <div class="stat-label">Citas Hoy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statUsuarios">0</div>
                            <div class="stat-label">Profesionales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statFacturadoMes">0‚Ç¨</div>
                            <div class="stat-label">Facturado Mes</div>
                        </div>
                    </div>

                    <h3>Citas de Hoy</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Paciente</th>
                                <th>Profesional</th>
                                <th>Tratamiento</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="citasHoyTable">
                            <tr><td colspan="5" style="text-align: center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pacientes -->
            <div id="pacientes" class="section">
                <div class="card">
                    <h2>Gesti√≥n de Pacientes</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="nuevoPaciente()">‚ûï Nuevo Paciente</button>
                        <button class="btn btn-success" onclick="loadPacientes()">üîÑ Actualizar</button>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>DNI</th>
                                <th>Nombre</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pacientesTable">
                            <tr><td colspan="5" style="text-align: center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Citas -->
            <div id="citas" class="section">
                <div class="card">
                    <h2>Gesti√≥n de Citas</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="nuevaCita()">‚ûï Nueva Cita</button>
                        <input type="date" id="filtroCitas" class="form-control" style="width: 200px; display: inline-block; margin-left: 10px;">
                        <button class="btn btn-success" onclick="loadCitas()">üîÑ Actualizar</button>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Paciente</th>
                                <th>Profesional</th>
                                <th>Tratamiento</th>
                                <th>Precio</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="citasTable">
                            <tr><td colspan="8" style="text-align: center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Actos y Bonos -->
            <div id="actos" class="section">
                <div class="card">
                    <h2>Gesti√≥n de Actos y Bonos</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="nuevoActo()">‚ûï Nuevo Acto</button>
                        <button class="btn btn-success" onclick="loadActos()">üîÑ Actualizar</button>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Descripci√≥n</th>
                                <th>Duraci√≥n</th>
                                <th>Precio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="actosTable">
                            <tr><td colspan="5" style="text-align: center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Usuarios -->
            <div id="usuarios" class="section">
                <div class="card">
                    <h2>Gesti√≥n de Usuarios</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="nuevoUsuario()">‚ûï Nuevo Usuario</button>
                        <button class="btn btn-success" onclick="loadUsuarios()">üîÑ Actualizar</button>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Tipo</th>
                                <th>Especialidad</th>
                                <th>Tel√©fono</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usuariosTable">
                            <tr><td colspan="7" style="text-align: center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Configuraci√≥n -->
            <div id="config" class="section">
                <div class="card">
                    <h2>Configuraci√≥n del Sistema</h2>
                    
                    <div class="alert alert-info">
                        <strong>URL de API:</strong> <span id="currentUrl" style="font-size: 12px;"></span><br>
                        <strong>Estado:</strong> <span id="connectionStatus">üü¢ Conectado</span>
                    </div>
                    
                    <button class="btn btn-warning" onclick="testConnection()">üîß Probar Conexi√≥n</button>
                    <button class="btn btn-danger" onclick="changeConnection()">üîÑ Cambiar Conexi√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">T√≠tulo</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // VARIABLES GLOBALES
        // =============================================
        let SCRIPT_URL = localStorage.getItem('fisiogest_script_url') || '';
        let currentUser = null;
        let dataCache = {
            pacientes: [],
            citas: [],
            usuarios: [],
            actos: [],
            facturas: []
        };

        // =============================================
        // INICIALIZACI√ìN
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            if (!SCRIPT_URL) {
                // Si no hay URL guardada, pedir configuraci√≥n
                const url = prompt('Por favor, ingresa la URL de tu Google Apps Script Web App:');
                if (url) {
                    SCRIPT_URL = url;
                    localStorage.setItem('fisiogest_script_url', url);
                    location.reload();
                }
            } else {
                document.getElementById('currentUrl').textContent = SCRIPT_URL.substring(0, 50) + '...';
            }
            
            // Configurar fecha actual
            document.getElementById('filtroCitas').value = new Date().toISOString().split('T')[0];
        });

        // =============================================
        // LOGIN
        // =============================================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                // Leer usuarios de la hoja
                const usuarios = await readSheet('Usuarios');
                
                // Buscar usuario
                const user = usuarios.find(u => u[2] === email && u[3] === password);
                
                if (user) {
                    currentUser = {
                        id: user[0],
                        nombre: user[1],
                        email: user[2],
                        tipo: user[4]
                    };
                    
                    // Guardar sesi√≥n
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Mostrar app
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('userName').textContent = currentUser.nombre;
                    document.getElementById('userType').textContent = currentUser.tipo;
                    
                    // Cargar datos iniciales
                    loadDashboard();
                } else {
                    showLoginError('Usuario o contrase√±a incorrectos');
                }
            } catch (error) {
                console.error('Error en login:', error);
                showLoginError('Error de conexi√≥n. Verifica la configuraci√≥n.');
            }
        });

        function showLoginError(message) {
            const div = document.getElementById('loginError');
            div.textContent = message;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 5000);
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            location.reload();
        }

        // Verificar sesi√≥n guardada
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser && SCRIPT_URL) {
            currentUser = JSON.parse(savedUser);
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.nombre;
            document.getElementById('userType').textContent = currentUser.tipo;
            loadDashboard();
        }

        // =============================================
        // FUNCIONES API CORREGIDAS
        // =============================================
        async function readSheet(sheetName) {
            try {
                const url = `${SCRIPT_URL}?action=read&sheet=${sheetName}`;
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) throw new Error('Error en respuesta');
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    return result.data || [];
                } else {
                    throw new Error(result.message || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error leyendo ' + sheetName + ':', error);
                showNotification('Error al leer datos de ' + sheetName, 'error');
                return [];
            }
        }

function doGet(e) {
  try {
    const action = e.parameter.action;
    const sheet = e.parameter.sheet;
    
    // Test de conexi√≥n
    if (action === 'test') {
      return ContentService.createTextOutput(
        JSON.stringify({ status: 'success', message: 'Conexi√≥n establecida' })
      ).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Lectura de datos
    if (action === 'read' && sheet) {
      const data = readData(sheet);
      return ContentService.createTextOutput(
        JSON.stringify({ status: 'success', data: data })
      ).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Escritura de datos (nuevo para evitar CORS)
    if (action && sheet && e.parameter.data) {
      try {
        const data = JSON.parse(e.parameter.data);
        let result;
        
        switch (action) {
          case 'add':
            result = addData(sheet, data);
            break;
          case 'update':
            result = updateData(sheet, data);
            break;
          case 'delete':
            result = deleteData(sheet, data);
            break;
          default:
            throw new Error('Acci√≥n no v√°lida');
        }
        
        return ContentService.createTextOutput(
          JSON.stringify({ status: 'success', result: result })
        ).setMimeType(ContentService.MimeType.JSON);
      } catch (error) {
        return ContentService.createTextOutput(
          JSON.stringify({ status: 'error', message: error.toString() })
        ).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    return ContentService.createTextOutput(
      JSON.stringify({ status: 'error', message: 'Acci√≥n no v√°lida' })
    ).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(
      JSON.stringify({ status: 'error', message: error.toString() })
    ).setMimeType(ContentService.MimeType.JSON);
  }
};
        
        // Construir URL con par√°metros
        const url = SCRIPT_URL + '?' + Object.keys(params)
            .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
            .join('&');
        
        const response = await fetch(url, {
            method: 'GET',
            mode: 'no-cors'
        });
        
        // Como usamos no-cors, asumimos √©xito si no hay error
        return true;
        
    } catch (error) {
        console.error('Error escribiendo en ' + sheetName + ':', error);
        showNotification('Error al guardar: ' + error.message, 'error');
        return false;
    }
}

        // =============================================
        // NAVEGACI√ìN
        // =============================================
        function showSection(section) {
            // Remover clases activas
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            
            // Activar secci√≥n actual
            event.target.classList.add('active');
            document.getElementById(section).classList.add('active');
            
            // Cargar datos de la secci√≥n
            switch(section) {
                case 'dashboard': loadDashboard(); break;
                case 'pacientes': loadPacientes(); break;
                case 'citas': loadCitas(); break;
                case 'actos': loadActos(); break;
                case 'usuarios': loadUsuarios(); break;
            }
        }

        // =============================================
        // DASHBOARD
        // =============================================
        async function loadDashboard() {
            try {
                const [pacientes, citas, usuarios, facturas] = await Promise.all([
                    readSheet('Pacientes'),
                    readSheet('Citas'),
                    readSheet('Usuarios'),
                    readSheet('Facturas')
                ]);
                
                // Actualizar estad√≠sticas
                document.getElementById('statPacientes').textContent = pacientes.length;
                document.getElementById('statUsuarios').textContent = usuarios.filter(u => u[4] !== 'Administrativo').length;
                
                // Citas de hoy
                const hoy = new Date().toISOString().split('T')[0];
                const citasHoy = citas.filter(c => c[1] === hoy);
                document.getElementById('statCitasHoy').textContent = citasHoy.length;
                
                // Facturado del mes
                const mes = new Date().getMonth();
                const a√±o = new Date().getFullYear();
                let totalMes = 0;
                facturas.forEach(f => {
                    if (f[2]) {
                        const fecha = new Date(f[2]);
                        if (fecha.getMonth() === mes && fecha.getFullYear() === a√±o) {
                            totalMes += parseFloat(f[8]) || 0;
                        }
                    }
                });
                document.getElementById('statFacturadoMes').textContent = totalMes.toFixed(2) + '‚Ç¨';
                
                // Tabla de citas de hoy
                const tbody = document.getElementById('citasHoyTable');
                if (citasHoy.length > 0) {
                    tbody.innerHTML = citasHoy.map(c => `
                        <tr>
                            <td>${c[2] || ''}</td>
                            <td>${c[4] || ''}</td>
                            <td>${c[5] || ''}</td>
                            <td>${c[6] || ''}</td>
                            <td><span class="badge badge-${getStatusBadge(c[9])}">${c[9] || 'Pendiente'}</span></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay citas para hoy</td></tr>';
                }
            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'Completada': return 'success';
                case 'Cancelada': return 'danger';
                case 'Confirmada': return 'info';
                default: return 'warning';
            }
        }

        // =============================================
        // PACIENTES
        // =============================================
        async function loadPacientes() {
            const pacientes = await readSheet('Pacientes');
            dataCache.pacientes = pacientes;
            
            const tbody = document.getElementById('pacientesTable');
            if (pacientes.length > 0) {
                tbody.innerHTML = pacientes.map(p => `
                    <tr>
                        <td>${p[1] || ''}</td>
                        <td>${p[2] || ''} ${p[3] || ''}</td>
                        <td>${p[4] || ''}</td>
                        <td>${p[5] || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editarPaciente('${p[0]}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarPaciente('${p[0]}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay pacientes</td></tr>';
            }
        }

        function nuevoPaciente() {
            const html = `
                <form id="formPaciente" onsubmit="guardarPaciente(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>DNI *</label>
                            <input type="text" class="form-control" name="dni" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha Nacimiento</label>
                            <input type="date" class="form-control" name="fechaNac">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" class="form-control" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Apellidos *</label>
                            <input type="text" class="form-control" name="apellidos" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tel√©fono *</label>
                            <input type="tel" class="form-control" name="telefono" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" class="form-control" name="direccion">
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            `;
            
            openModal('Nuevo Paciente', html);
        }

        async function guardarPaciente(event) {
            event.preventDefault();
            const form = event.target;
            
            const valores = {
                values: [
                    'P' + Date.now(),
                    form.dni.value,
                    form.nombre.value,
                    form.apellidos.value,
                    form.telefono.value,
                    form.email.value,
                    form.fechaNac.value,
                    form.direccion.value,
                    '',
                    '',
                    new Date().toISOString().split('T')[0],
                    'Activo'
                ]
            };
            
            const success = await writeSheet('Pacientes', 'add', valores);
            
            if (success) {
                closeModal();
                loadPacientes();
                showNotification('Paciente guardado correctamente', 'success');
            }
        }

        async function eliminarPaciente(id) {
            if (confirm('¬øEst√°s seguro de eliminar este paciente?')) {
                const success = await writeSheet('Pacientes', 'delete', { id: id });
                if (success) {
                    loadPacientes();
                    showNotification('Paciente eliminado', 'success');
                }
            }
        }

        // =============================================
        // CITAS
        // =============================================
        async function loadCitas() {
            const citas = await readSheet('Citas');
            const filtro = document.getElementById('filtroCitas').value;
            
            const citasFiltradas = filtro ? citas.filter(c => c[1] === filtro) : citas;
            
            const tbody = document.getElementById('citasTable');
            if (citasFiltradas.length > 0) {
                tbody.innerHTML = citasFiltradas.map(c => `
                    <tr>
                        <td>${c[1] || ''}</td>
                        <td>${c[2] || ''}</td>
                        <td>${c[4] || ''}</td>
                        <td>${c[5] || ''}</td>
                        <td>${c[6] || ''}</td>
                        <td>${c[8] || 0}‚Ç¨</td>
                        <td><span class="badge badge-${getStatusBadge(c[9])}">${c[9] || 'Pendiente'}</span></td>
                        <td>
                            ${c[9] !== 'Completada' ? 
                                `<button class="btn btn-sm btn-success" onclick="completarCita('${c[0]}')">‚úî</button>` : ''}
                            <button class="btn btn-sm btn-danger" onclick="eliminarCita('${c[0]}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No hay citas</td></tr>';
            }
        }

        async function nuevaCita() {
            // Primero cargar los datos necesarios
            await loadPacientes();
            const usuarios = await readSheet('Usuarios');
            const actos = await readSheet('Actos');
            
            const html = `
                <form id="formCita" onsubmit="guardarCita(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha *</label>
                            <input type="date" class="form-control" name="fecha" required 
                                   value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Hora *</label>
                            <input type="time" class="form-control" name="hora" required value="10:00">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Paciente *</label>
                        <select class="form-control" name="pacienteId" required>
                            <option value="">Seleccionar...</option>
                            ${dataCache.pacientes.map(p => 
                                `<option value="${p[0]}">${p[2]} ${p[3]} - ${p[1]}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Profesional *</label>
                        <select class="form-control" name="profesionalId" required>
                            <option value="">Seleccionar...</option>
                            ${usuarios.filter(u => u[4] === 'Fisioterapeuta' || u[4] === 'Entrenador')
                                .map(u => `<option value="${u[0]}">${u[1]} - ${u[4]}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Tratamiento *</label>
                        <select class="form-control" name="actoId" required onchange="updatePrecioCita(this)">
                            <option value="">Seleccionar...</option>
                            ${actos.map(a => `
                                <option value="${a[0]}" data-duracion="${a[3]}" data-precio="${a[4]}" data-nombre="${a[1]}">
                                    ${a[1]} - ${a[4]}‚Ç¨
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Duraci√≥n (min)</label>
                            <input type="number" class="form-control" name="duracion" id="duracionCita" readonly>
                        </div>
                        <div class="form-group">
                            <label>Precio (‚Ç¨)</label>
                            <input type="number" step="0.01" class="form-control" name="precio" id="precioCita">
                        </div>
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cita</button>
                    </div>
                </form>
            `;
            
            openModal('Nueva Cita', html);
        }

        function updatePrecioCita(select) {
            const option = select.options[select.selectedIndex];
            if (option && option.dataset) {
                document.getElementById('duracionCita').value = option.dataset.duracion || '';
                document.getElementById('precioCita').value = option.dataset.precio || '';
            }
        }

        async function guardarCita(event) {
            event.preventDefault();
            const form = event.target;
            
            // Obtener datos del paciente seleccionado
            const paciente = dataCache.pacientes.find(p => p[0] === form.pacienteId.value);
            const profesionalSelect = form.profesionalId;
            const profesional = profesionalSelect.options[profesionalSelect.selectedIndex].text.split(' - ')[0];
            const actoSelect = form.actoId;
            const acto = actoSelect.options[actoSelect.selectedIndex].dataset.nombre;
            
            const valores = {
                values: [
                    'C' + Date.now(),
                    form.fecha.value,
                    form.hora.value,
                    form.pacienteId.value,
                    paciente ? `${paciente[2]} ${paciente[3]}` : '',
                    profesional,
                    acto,
                    form.duracion.value,
                    form.precio.value,
                    'Pendiente',
                    '',
                    new Date().toISOString()
                ]
            };
            
            const success = await writeSheet('Citas', 'add', valores);
            
            if (success) {
                closeModal();
                loadCitas();
                showNotification('Cita guardada correctamente', 'success');
            }
        }

        async function completarCita(id) {
            const success = await writeSheet('Citas', 'update', { 
                id: id, 
                column: 10, 
                value: 'Completada' 
            });
            
            if (success) {
                loadCitas();
                showNotification('Cita marcada como completada', 'success');
            }
        }

        async function eliminarCita(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta cita?')) {
                const success = await writeSheet('Citas', 'delete', { id: id });
                if (success) {
                    loadCitas();
                    showNotification('Cita eliminada', 'success');
                }
            }
        }

        // =============================================
        // ACTOS
        // =============================================
        async function loadActos() {
            const actos = await readSheet('Actos');
            dataCache.actos = actos;
            
            const tbody = document.getElementById('actosTable');
            if (actos.length > 0) {
                tbody.innerHTML = actos.map(a => `
                    <tr>
                        <td>${a[1] || ''}</td>
                        <td>${a[2] || ''}</td>
                        <td>${a[3] || 0} min</td>
                        <td>${a[4] || 0}‚Ç¨</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="eliminarActo('${a[0]}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay actos</td></tr>';
            }
        }

        function nuevoActo() {
            const html = `
                <form id="formActo" onsubmit="guardarActo(event)">
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" class="form-control" name="nombre" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea class="form-control" name="descripcion" rows="3"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Duraci√≥n (minutos) *</label>
                            <select class="form-control" name="duracion" required>
                                <option value="15">15 min</option>
                                <option value="30">30 min</option>
                                <option value="45" selected>45 min</option>
                                <option value="60">60 min</option>
                                <option value="90">90 min</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Precio (‚Ç¨) *</label>
                            <input type="number" step="0.01" class="form-control" name="precio" required>
                        </div>
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            `;
            
            openModal('Nuevo Acto', html);
        }

        async function guardarActo(event) {
            event.preventDefault();
            const form = event.target;
            
            const valores = {
                values: [
                    'A' + Date.now(),
                    form.nombre.value,
                    form.descripcion.value,
                    form.duracion.value,
                    form.precio.value,
                    '#667eea',
                    'Activo'
                ]
            };
            
            const success = await writeSheet('Actos', 'add', valores);
            
            if (success) {
                closeModal();
                loadActos();
                showNotification('Acto guardado correctamente', 'success');
            }
        }

        async function eliminarActo(id) {
            if (confirm('¬øEst√°s seguro de eliminar este acto?')) {
                const success = await writeSheet('Actos', 'delete', { id: id });
                if (success) {
                    loadActos();
                    showNotification('Acto eliminado', 'success');
                }
            }
        }

        // =============================================
        // USUARIOS
        // =============================================
        async function loadUsuarios() {
            const usuarios = await readSheet('Usuarios');
            dataCache.usuarios = usuarios;
            
            const tbody = document.getElementById('usuariosTable');
            if (usuarios.length > 0) {
                tbody.innerHTML = usuarios.map(u => `
                    <tr>
                        <td>${u[1] || ''}</td>
                        <td>${u[2] || ''}</td>
                        <td>${u[4] || ''}</td>
                        <td>${u[5] || ''}</td>
                        <td>${u[6] || ''}</td>
                        <td><span class="badge badge-${u[8] === 'Activo' ? 'success' : 'danger'}">${u[8] || 'Activo'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="eliminarUsuario('${u[0]}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay usuarios</td></tr>';
            }
        }

        function nuevoUsuario() {
            const html = `
                <form id="formUsuario" onsubmit="guardarUsuario(event)">
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" class="form-control" name="nombre" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="form-group">
                            <label>Contrase√±a *</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo *</label>
                            <select class="form-control" name="tipo" required>
                                <option value="Fisioterapeuta">Fisioterapeuta</option>
                                <option value="Entrenador">Entrenador</option>
                                <option value="Administrativo">Administrativo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Especialidad</label>
                            <input type="text" class="form-control" name="especialidad">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" class="form-control" name="telefono">
                        </div>
                        <div class="form-group">
                            <label>N¬∫ Colegiado</label>
                            <input type="text" class="form-control" name="colegiado">
                        </div>
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            `;
            
            openModal('Nuevo Usuario', html);
        }

        async function guardarUsuario(event) {
            event.preventDefault();
            const form = event.target;
            
            const valores = {
                values: [
                    'U' + Date.now(),
                    form.nombre.value,
                    form.email.value,
                    form.password.value,
                    form.tipo.value,
                    form.especialidad.value,
                    form.telefono.value,
                    form.colegiado.value,
                    'Activo'
                ]
            };
            
            const success = await writeSheet('Usuarios', 'add', valores);
            
            if (success) {
                closeModal();
                loadUsuarios();
                showNotification('Usuario creado correctamente', 'success');
            }
        }

        async function eliminarUsuario(id) {
            if (confirm('¬øEst√°s seguro de eliminar este usuario?')) {
                const success = await writeSheet('Usuarios', 'delete', { id: id });
                if (success) {
                    loadUsuarios();
                    showNotification('Usuario eliminado', 'success');
                }
            }
        }

        // =============================================
        // UTILIDADES
        // =============================================
        function openModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showNotification(message, type) {
            const div = document.createElement('div');
            div.className = `notification ${type}`;
            div.textContent = message;
            document.body.appendChild(div);
            
            setTimeout(() => div.remove(), 3000);
        }

        async function testConnection() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=test');
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification('‚úÖ Conexi√≥n exitosa', 'success');
                    document.getElementById('connectionStatus').innerHTML = 'üü¢ Conectado';
                } else {
                    showNotification('‚ùå Error de conexi√≥n', 'error');
                    document.getElementById('connectionStatus').innerHTML = 'üî¥ Desconectado';
                }
            } catch (error) {
                showNotification('‚ùå No se pudo conectar', 'error');
                document.getElementById('connectionStatus').innerHTML = 'üî¥ Desconectado';
            }
        }

        function changeConnection() {
            if (confirm('¬øCambiar la URL de conexi√≥n? Esto cerrar√° tu sesi√≥n actual.')) {
                localStorage.removeItem('fisiogest_script_url');
                localStorage.removeItem('currentUser');
                location.reload();
            }
        }

        function editarPaciente(id) {
            // Funci√≥n para editar paciente (puedes implementarla m√°s adelante)
            showNotification('Funci√≥n de edici√≥n en desarrollo', 'info');
        }
    </script>
</body>
</html>
