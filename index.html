<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="FisioGest Pro - Sistema de gesti√≥n para cl√≠nicas de fisioterapia">
    <title>FisioGest Pro - Sistema de Gesti√≥n</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* ====================== */
        /* LOGIN SCREEN */
        /* ====================== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h2 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-box p {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        /* ====================== */
        /* MAIN APP */
        /* ====================== */
        .app-container {
            display: none;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: #f8f9fa;
            display: flex;
            overflow-x: auto;
            border-bottom: 2px solid #dee2e6;
            padding: 0 15px;
        }

        .nav-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        /* Content Area */
        .content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        .card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .stat-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Calendar */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #dee2e6;
            border: 1px solid #dee2e6;
        }

        .calendar-day-header {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 5px;
            position: relative;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            opacity: 0.5;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }

        .calendar-day.today .calendar-day-number {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .appointment-item {
            background: #667eea;
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 2px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .appointment-item:hover {
            background: #764ba2;
        }

        /* Form Layout */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 2px solid #dee2e6;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Search and Filters */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-bar input {
            flex: 1;
            min-width: 200px;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alerts */
        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.active {
            display: block;
            animation: slideIn 0.3s;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .content {
                padding: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .calendar-day {
                min-height: 60px;
            }

            .appointment-item {
                font-size: 9px;
                padding: 2px 4px;
            }
        }

        /* Configuraci√≥n de Empresa */
        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .config-section h4 {
            margin-bottom: 15px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h2>FisioGest Pro</h2>
            <p>Sistema de Gesti√≥n de Cl√≠nica</p>
            <form id="loginForm">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="loginUser" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">Iniciar Sesi√≥n</button>
            </form>
            <div class="alert alert-danger" id="loginError"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <div class="header">
            <h1>FisioGest Pro</h1>
            <div class="user-info">
                <span id="currentUserName">Usuario</span>
                <span class="user-badge" id="currentUserType">Tipo</span>
                <button class="btn btn-secondary btn-sm" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection('agenda')">üìÖ Agenda</button>
            <button class="nav-tab" onclick="showSection('pacientes')">üë• Pacientes</button>
            <button class="nav-tab" onclick="showSection('profesionales')">üë®‚Äç‚öïÔ∏è Profesionales</button>
            <button class="nav-tab" onclick="showSection('actos')">üíº Actos</button>
            <button class="nav-tab" onclick="showSection('facturacion')">üí∞ Facturaci√≥n</button>
            <button class="nav-tab" onclick="showSection('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Section -->
            <div class="section active" id="dashboard">
                <h2>Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Citas Hoy</h4>
                        <div class="value" id="statCitasHoy">0</div>
                        <div class="change">+0% vs ayer</div>
                    </div>
                    <div class="stat-card">
                        <h4>Pacientes Activos</h4>
                        <div class="value" id="statPacientes">0</div>
                        <div class="change">Total en sistema</div>
                    </div>
                    <div class="stat-card">
                        <h4>Facturaci√≥n Mes</h4>
                        <div class="value" id="statFacturacion">0‚Ç¨</div>
                        <div class="change">+0% vs mes anterior</div>
                    </div>
                    <div class="stat-card">
                        <h4>Pendientes de Cobro</h4>
                        <div class="value" id="statPendientes">0‚Ç¨</div>
                        <div class="change">Facturas pendientes</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Exportar Datos</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Desde</label>
                            <input type="date" id="exportFechaDesde">
                        </div>
                        <div class="form-group">
                            <label>Hasta</label>
                            <input type="date" id="exportFechaHasta">
                        </div>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-success" onclick="exportarPacientes()">üì• Exportar Pacientes</button>
                        <button class="btn btn-success" onclick="exportarCitas()">üì• Exportar Citas</button>
                        <button class="btn btn-success" onclick="exportarFacturacion()">üì• Exportar Facturaci√≥n</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Pr√≥ximas Citas</h3>
                    <div class="table-container">
                        <table id="proximasCitasTable">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Paciente</th>
                                    <th>Profesional</th>
                                    <th>Acto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Agenda Section -->
            <div class="section" id="agenda">
                <div class="calendar-header">
                    <h2>Agenda</h2>
                    <div class="calendar-nav">
                        <button class="btn btn-secondary btn-sm" onclick="cambiarMes(-1)">‚óÄ Anterior</button>
                        <span id="mesActual" style="font-weight: 600; min-width: 150px; text-align: center;"></span>
                        <button class="btn btn-secondary btn-sm" onclick="cambiarMes(1)">Siguiente ‚ñ∂</button>
                        <button class="btn btn-primary" onclick="openModal('citaModal')">+ Nueva Cita</button>
                    </div>
                </div>

                <div class="card">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Filtrar por Profesional</label>
                            <select id="filtroProfesional" onchange="cargarAgenda()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vista</label>
                            <select id="vistaAgenda" onchange="cargarAgenda()">
                                <option value="mes">Mes</option>
                                <option value="semana">Semana</option>
                                <option value="dia">D√≠a</option>
                            </select>
                        </div>
                    </div>

                    <div class="calendar-grid" id="calendar"></div>
                </div>
            </div>

            <!-- Pacientes Section -->
            <div class="section" id="pacientes">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gesti√≥n de Pacientes</h2>
                    <button class="btn btn-primary" onclick="openModal('pacienteModal')">+ Nuevo Paciente</button>
                </div>

                <div class="card">
                    <div class="search-bar">
                        <input type="text" placeholder="Buscar paciente..." id="searchPaciente" oninput="filtrarPacientes()">
                        <select id="filtroPacienteEstado" onchange="filtrarPacientes()">
                            <option value="">Todos los estados</option>
                            <option value="Activo">Activos</option>
                            <option value="Inactivo">Inactivos</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table id="pacientesTable">
                            <thead>
                                <tr>
                                    <th>DNI/NIE</th>
                                    <th>Nombre</th>
                                    <th>Apellidos</th>
                                    <th>Tel√©fono</th>
                                    <th>Email</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Profesionales Section -->
            <div class="section" id="profesionales">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gesti√≥n de Profesionales</h2>
                    <button class="btn btn-primary" onclick="openModal('profesionalModal')">+ Nuevo Profesional</button>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table id="profesionalesTable">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Tipo</th>
                                    <th>Especialidad</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Actos Section -->
            <div class="section" id="actos">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Cat√°logo de Actos</h2>
                    <button class="btn btn-primary" onclick="openModal('actoModal')">+ Nuevo Acto</button>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table id="actosTable">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Nombre</th>
                                    <th>Tipo</th>
                                    <th>Duraci√≥n (min)</th>
                                    <th>Precio (‚Ç¨)</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Facturaci√≥n Section -->
            <div class="section" id="facturacion">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Facturaci√≥n</h2>
                    <button class="btn btn-primary" onclick="openModal('facturaModal')">+ Nueva Factura</button>
                </div>

                <div class="card">
                    <div class="search-bar">
                        <input type="date" id="filtroFacturaDesde">
                        <input type="date" id="filtroFacturaHasta">
                        <select id="filtroFacturaEstado" onchange="filtrarFacturas()">
                            <option value="">Todos los estados</option>
                            <option value="Pagada">Pagadas</option>
                            <option value="Pendiente">Pendientes</option>
                            <option value="Vencida">Vencidas</option>
                        </select>
                        <button class="btn btn-secondary" onclick="filtrarFacturas()">Filtrar</button>
                    </div>

                    <div class="table-container">
                        <table id="facturasTable">
                            <thead>
                                <tr>
                                    <th>N√∫mero</th>
                                    <th>Fecha</th>
                                    <th>Paciente</th>
                                    <th>Concepto</th>
                                    <th>Base</th>
                                    <th>IVA</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Configuraci√≥n Section -->
            <div class="section" id="configuracion">
                <h2>Configuraci√≥n</h2>

                <!-- Configuraci√≥n de Empresa -->
                <div class="card">
                    <h3>Datos de la Empresa</h3>
                    <form id="empresaForm">
                        <div class="config-section">
                            <h4>Informaci√≥n General</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nombre de la Empresa *</label>
                                    <input type="text" id="empresaNombre" required>
                                </div>
                                <div class="form-group">
                                    <label>CIF/NIF *</label>
                                    <input type="text" id="empresaCIF" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Direcci√≥n</label>
                                    <input type="text" id="empresaDireccion">
                                </div>
                                <div class="form-group">
                                    <label>C√≥digo Postal</label>
                                    <input type="text" id="empresaCP">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ciudad</label>
                                    <input type="text" id="empresaCiudad">
                                </div>
                                <div class="form-group">
                                    <label>Provincia</label>
                                    <input type="text" id="empresaProvincia">
                                </div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h4>Contacto</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tel√©fono</label>
                                    <input type="tel" id="empresaTelefono">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="empresaEmail">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Web</label>
                                    <input type="url" id="empresaWeb">
                                </div>
                            </div>
                        </div>

                        <div class="config-section">
                            <h4>Facturaci√≥n</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>IVA por defecto (%)</label>
                                    <input type="number" id="empresaIVA" value="21" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Forma de Pago por defecto</label>
                                    <select id="empresaFormaPago">
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Tarjeta">Tarjeta</option>
                                        <option value="Transferencia">Transferencia</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Observaciones en Factura</label>
                                <textarea id="empresaObservaciones" rows="3"></textarea>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Guardar Configuraci√≥n</button>
                    </form>
                </div>

                <!-- Gesti√≥n de Usuarios -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Usuarios del Sistema</h3>
                        <button class="btn btn-primary" onclick="openModal('usuarioModal')">+ Nuevo Usuario</button>
                    </div>
                    <div class="table-container">
                        <table id="usuariosTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Configuraci√≥n de Horarios -->
                <div class="card">
                    <h3>Horarios de Trabajo</h3>
                    <form id="horariosForm">
                        <div class="config-section">
                            <div class="form-group">
                                <label>Profesional</label>
                                <select id="horarioProfesional" required>
                                    <option value="">Seleccione...</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Lunes</label>
                                    <input type="text" id="horarioLunes" placeholder="09:00-14:00, 16:00-20:00">
                                </div>
                                <div class="form-group">
                                    <label>Martes</label>
                                    <input type="text" id="horarioMartes" placeholder="09:00-14:00, 16:00-20:00">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Mi√©rcoles</label>
                                    <input type="text" id="horarioMiercoles" placeholder="09:00-14:00, 16:00-20:00">
                                </div>
                                <div class="form-group">
                                    <label>Jueves</label>
                                    <input type="text" id="horarioJueves" placeholder="09:00-14:00, 16:00-20:00">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Viernes</label>
                                    <input type="text" id="horarioViernes" placeholder="09:00-14:00, 16:00-20:00">
                                </div>
                                <div class="form-group">
                                    <label>S√°bado</label>
                                    <input type="text" id="horarioSabado" placeholder="09:00-14:00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Domingo</label>
                                <input type="text" id="horarioDomingo" placeholder="Cerrado">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar Horarios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Nueva Cita -->
    <div class="modal" id="citaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nueva Cita</h3>
                <button class="close-modal" onclick="closeModal('citaModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="citaForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha *</label>
                            <input type="date" name="fecha" required>
                        </div>
                        <div class="form-group">
                            <label>Hora *</label>
                            <input type="time" name="hora" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Paciente *</label>
                        <select name="pacienteId" required>
                            <option value="">Seleccione un paciente...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Profesional *</label>
                        <select name="profesional" required>
                            <option value="">Seleccione un profesional...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Acto *</label>
                        <select name="acto" required onchange="actualizarDuracionPrecio(this)">
                            <option value="">Seleccione un acto...</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Duraci√≥n (min) *</label>
                            <input type="number" name="duracion" required>
                        </div>
                        <div class="form-group">
                            <label>Precio (‚Ç¨) *</label>
                            <input type="number" name="precio" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea name="observaciones" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('citaModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarCita()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Nuevo Paciente -->
    <div class="modal" id="pacienteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Paciente</h3>
                <button class="close-modal" onclick="closeModal('pacienteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="pacienteForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>DNI/NIE *</label>
                            <input type="text" name="dni" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" name="nombre" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Apellidos *</label>
                            <input type="text" name="apellidos" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Nacimiento</label>
                            <input type="date" name="fechaNacimiento">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" name="telefono">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" name="email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" name="direccion">
                    </div>
                    <div class="form-group">
                        <label>Historial M√©dico</label>
                        <textarea name="historial" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('pacienteModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarPaciente()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Nuevo Profesional -->
    <div class="modal" id="profesionalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Profesional</h3>
                <button class="close-modal" onclick="closeModal('profesionalModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profesionalForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" name="email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo *</label>
                            <select name="tipo" required>
                                <option value="Fisioterapeuta">Fisioterapeuta</option>
                                <option value="Administrativo">Administrativo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Especialidad</label>
                            <input type="text" name="especialidad">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" name="telefono">
                        </div>
                        <div class="form-group">
                            <label>Num. Colegiado</label>
                            <input type="text" name="numColegiado">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('profesionalModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarProfesional()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Nuevo Acto -->
    <div class="modal" id="actoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Acto</h3>
                <button class="close-modal" onclick="closeModal('actoModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="actoForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>C√≥digo *</label>
                            <input type="text" name="codigo" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" name="nombre" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tipo *</label>
                        <select name="tipo" required>
                            <option value="Fisioterapia">Fisioterapia</option>
                            <option value="Osteopat√≠a">Osteopat√≠a</option>
                            <option value="Masaje">Masaje</option>
                            <option value="Readaptaci√≥n">Readaptaci√≥n</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Duraci√≥n (minutos) *</label>
                            <input type="number" name="duracion" required>
                        </div>
                        <div class="form-group">
                            <label>Precio (‚Ç¨) *</label>
                            <input type="number" name="precio" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea name="descripcion" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('actoModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarActo()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Nueva Factura -->
    <div class="modal" id="facturaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nueva Factura</h3>
                <button class="close-modal" onclick="closeModal('facturaModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="facturaForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha *</label>
                            <input type="date" name="fecha" required>
                        </div>
                        <div class="form-group">
                            <label>Paciente *</label>
                            <select name="pacienteId" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Concepto *</label>
                        <textarea name="concepto" rows="2" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Base Imponible (‚Ç¨) *</label>
                            <input type="number" name="base" step="0.01" required onchange="calcularTotal()">
                        </div>
                        <div class="form-group">
                            <label>IVA (%) *</label>
                            <input type="number" name="iva" value="21" step="0.01" required onchange="calcularTotal()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Total (‚Ç¨)</label>
                        <input type="number" name="total" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label>Forma de Pago</label>
                        <select name="formaPago">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Transferencia">Transferencia</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('facturaModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarFactura()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Nuevo Usuario -->
    <div class="modal" id="usuarioModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Usuario</h3>
                <button class="close-modal" onclick="closeModal('usuarioModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="usuarioForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" name="email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Contrase√±a *</label>
                            <input type="password" name="password" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo *</label>
                            <select name="tipo" required>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Fisioterapeuta">Fisioterapeuta</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('usuarioModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarUsuario()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // ================================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // ================================================
        
        // IMPORTANTE: Reemplaza esta URL con la URL de tu Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbxSD_F8GugbG56pbTbtW5qae_5SVPh7_ottqaTabVrGxSTTD0dOci80znVzo0OC2Dmj/exec';
        
        // Variables globales
        let currentUser = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let allData = {
            usuarios: [],
            pacientes: [],
            profesionales: [],
            actos: [],
            citas: [],
            facturas: [],
            empresa: {},
            horarios: []
        };

        // ================================================
        // INICIALIZACI√ìN
        // ================================================
        
        window.onload = function() {
            verificarConexion();
            setupEventListeners();
        };

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', login);
            document.getElementById('empresaForm').addEventListener('submit', guardarEmpresa);
            document.getElementById('horariosForm').addEventListener('submit', guardarHorarios);
        }

        // ================================================
        // AUTENTICACI√ìN
        // ================================================

        async function login(e) {
            e.preventDefault();
            showLoading(true);

            const usuario = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPassword').value;

            try {
                await cargarDatos();
                
                const user = allData.usuarios.find(u => 
                    (u[2] === usuario || u[1] === usuario) && u[3] === password && u[8] === 'Activo'
                );

                if (user) {
                    currentUser = {
                        id: user[0],
                        nombre: user[1],
                        email: user[2],
                        tipo: user[4]
                    };

                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    
                    document.getElementById('currentUserName').textContent = currentUser.nombre;
                    document.getElementById('currentUserType').textContent = currentUser.tipo;
                    
                    await inicializarApp();
                } else {
                    showAlert('Usuario o contrase√±a incorrectos', 'danger', 'loginError');
                }
            } catch (error) {
                console.error('Error en login:', error);
                showAlert('Error al iniciar sesi√≥n: ' + error.message, 'danger', 'loginError');
            }

            showLoading(false);
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // ================================================
        // GESTI√ìN DE DATOS
        // ================================================

        async function verificarConexion() {
            try {
                const response = await fetch(API_URL + '?action=test');
                const data = await response.json();
                
                if (data.status !== 'success') {
                    console.error('Error de conexi√≥n:', data.message);
                }
            } catch (error) {
                console.error('No se pudo conectar con el servidor:', error);
            }
        }

        async function cargarDatos() {
            const sheets = ['Usuarios', 'Pacientes', 'Profesionales', 'Actos', 'Citas', 'Facturas', 'Empresa', 'Horarios'];
            
            for (const sheet of sheets) {
                try {
                    const response = await fetch(API_URL + '?action=read&sheet=' + sheet);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        allData[sheet.toLowerCase()] = result.data || [];
                    }
                } catch (error) {
                    console.error('Error cargando ' + sheet + ':', error);
                }
            }
        }

        async function guardarDato(sheet, data) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'add',
                        sheet: sheet,
                        data: data
                    })
                });

                const result = await response.json();
                return result.status === 'success';
            } catch (error) {
                console.error('Error guardando en ' + sheet + ':', error);
                return false;
            }
        }

        async function actualizarDato(sheet, id, data) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update',
                        sheet: sheet,
                        id: id,
                        data: data
                    })
                });

                const result = await response.json();
                return result.status === 'success';
            } catch (error) {
                console.error('Error actualizando ' + sheet + ':', error);
                return false;
            }
        }

        async function eliminarDato(sheet, id) {
            if (!confirm('¬øEst√° seguro de que desea eliminar este registro?')) {
                return false;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'delete',
                        sheet: sheet,
                        id: id
                    })
                });

                const result = await response.json();
                return result.status === 'success';
            } catch (error) {
                console.error('Error eliminando de ' + sheet + ':', error);
                return false;
            }
        }

        // ================================================
        // INICIALIZACI√ìN DE LA APP
        // ================================================

        async function inicializarApp() {
            await cargarDatos();
            actualizarDashboard();
            cargarTablaPacientes();
            cargarTablaProfesionales();
            cargarTablaActos();
            cargarTablaFacturas();
            cargarTablaUsuarios();
            cargarAgenda();
            cargarConfiguracionEmpresa();
            poblarSelectsPacientes();
            poblarSelectsProfesionales();
            poblarSelectsActos();
        }

        // ================================================
        // NAVEGACI√ìN
        // ================================================

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            if (sectionId === 'agenda') {
                cargarAgenda();
            } else if (sectionId === 'dashboard') {
                actualizarDashboard();
            }
        }

        // ================================================
        // DASHBOARD
        // ================================================

        function actualizarDashboard() {
            const hoy = new Date().toISOString().split('T')[0];
            const citasHoy = allData.citas.filter(c => c[1] === hoy);
            const pacientesActivos = allData.pacientes.filter(p => p[7] === 'Activo');
            
            const mesActual = new Date().getMonth();
            const a√±oActual = new Date().getFullYear();
            const facturacionMes = allData.facturas
                .filter(f => {
                    const fecha = new Date(f[2]);
                    return fecha.getMonth() === mesActual && fecha.getFullYear() === a√±oActual;
                })
                .reduce((sum, f) => sum + parseFloat(f[8] || 0), 0);
            
            const pendientesCobro = allData.facturas
                .filter(f => f[9] === 'Pendiente')
                .reduce((sum, f) => sum + parseFloat(f[8] || 0), 0);

            document.getElementById('statCitasHoy').textContent = citasHoy.length;
            document.getElementById('statPacientes').textContent = pacientesActivos.length;
            document.getElementById('statFacturacion').textContent = facturacionMes.toFixed(2) + '‚Ç¨';
            document.getElementById('statPendientes').textContent = pendientesCobro.toFixed(2) + '‚Ç¨';

            cargarProximasCitas();
        }

        function cargarProximasCitas() {
            const tbody = document.querySelector('#proximasCitasTable tbody');
            const hoy = new Date();
            
            const proximasCitas = allData.citas
                .filter(c => {
                    const fechaCita = new Date(c[1] + 'T' + c[2]);
                    return fechaCita >= hoy;
                })
                .sort((a, b) => {
                    const fechaA = new Date(a[1] + 'T' + a[2]);
                    const fechaB = new Date(b[1] + 'T' + b[2]);
                    return fechaA - fechaB;
                })
                .slice(0, 10);

            tbody.innerHTML = proximasCitas.map(cita => {
                const estado = cita[9] || 'Pendiente';
                const badgeClass = estado === 'Confirmada' ? 'badge-success' : 
                                  estado === 'Cancelada' ? 'badge-danger' : 'badge-warning';
                
                return `
                    <tr>
                        <td>${formatearFecha(cita[1])}</td>
                        <td>${cita[2]}</td>
                        <td>${cita[4]}</td>
                        <td>${cita[5]}</td>
                        <td>${cita[6]}</td>
                        <td><span class="badge ${badgeClass}">${estado}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ================================================
        // AGENDA - CALENDARIO
        // ================================================

        function cargarAgenda() {
            const vista = document.getElementById('vistaAgenda').value;
            
            if (vista === 'mes') {
                cargarCalendarioMes();
            } else if (vista === 'semana') {
                cargarCalendarioSemana();
            } else {
                cargarCalendarioDia();
            }

            poblarFiltroProfesionales();
        }

        function cargarCalendarioMes() {
            const calendar = document.getElementById('calendar');
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const prevLastDay = new Date(currentYear, currentMonth, 0);
            
            const firstDayWeek = firstDay.getDay() || 7;
            const lastDayNum = lastDay.getDate();
            const prevLastDayNum = prevLastDay.getDate();
            
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            document.getElementById('mesActual').textContent = 
                monthNames[currentMonth] + ' ' + currentYear;

            const filtroProfesional = document.getElementById('filtroProfesional').value;
            const citasMes = allData.citas.filter(c => {
                const fechaCita = new Date(c[1]);
                const cumpleFecha = fechaCita.getMonth() === currentMonth && 
                                   fechaCita.getFullYear() === currentYear;
                const cumpleProfesional = !filtroProfesional || c[5] === filtroProfesional;
                return cumpleFecha && cumpleProfesional;
            });

            let html = `
                <div class="calendar-day-header">Lun</div>
                <div class="calendar-day-header">Mar</div>
                <div class="calendar-day-header">Mi√©</div>
                <div class="calendar-day-header">Jue</div>
                <div class="calendar-day-header">Vie</div>
                <div class="calendar-day-header">S√°b</div>
                <div class="calendar-day-header">Dom</div>
            `;

            for (let i = firstDayWeek - 1; i > 0; i--) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${prevLastDayNum - i + 1}</div>
                </div>`;
            }

            const hoy = new Date();
            const esHoy = (dia) => 
                dia === hoy.getDate() && 
                currentMonth === hoy.getMonth() && 
                currentYear === hoy.getFullYear();

            for (let dia = 1; dia <= lastDayNum; dia++) {
                const fecha = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                const citasDia = citasMes.filter(c => c[1] === fecha);
                
                html += `
                    <div class="calendar-day ${esHoy(dia) ? 'today' : ''}" onclick="verCitasDia('${fecha}')">
                        <div class="calendar-day-number">${dia}</div>
                        ${citasDia.map(cita => `
                            <div class="appointment-item" title="${cita[4]} - ${cita[2]}">
                                ${cita[2]} ${cita[4]}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            const nextDays = (7 - ((firstDayWeek - 1 + lastDayNum) % 7)) % 7;
            for (let i = 1; i <= nextDays; i++) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${i}</div>
                </div>`;
            }

            calendar.innerHTML = html;
        }

        function cambiarMes(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            cargarAgenda();
        }

        function verCitasDia(fecha) {
            alert('Ver citas del d√≠a: ' + formatearFecha(fecha));
        }

        // ================================================
        // GESTI√ìN DE CITAS
        // ================================================

        async function guardarCita() {
            showLoading(true);
            const form = document.getElementById('citaForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                showLoading(false);
                return;
            }

            // CORRECCI√ìN CR√çTICA: No convertir las fechas, usarlas directamente
            const paciente = allData.pacientes.find(p => p[0] === form.pacienteId.value);
            const profesional = form.profesional.value;
            const acto = form.acto.value;

            const valores = {
                values: [
                    'C' + Date.now(),
                    form.fecha.value,  // Usar directamente el valor del input (formato YYYY-MM-DD)
                    form.hora.value,   // Usar directamente el valor del input (formato HH:MM)
                    form.pacienteId.value,
                    paciente ? `${paciente[2]} ${paciente[3]}` : '',
                    profesional,
                    acto,
                    form.duracion.value,
                    form.precio.value,
                    'Pendiente',
                    form.observaciones.value || '',
                    new Date().toISOString()
                ]
            };

            const success = await guardarDato('Citas', valores.values);

            if (success) {
                alert('Cita guardada correctamente');
                closeModal('citaModal');
                form.reset();
                await cargarDatos();
                cargarAgenda();
                actualizarDashboard();
            } else {
                alert('Error al guardar la cita');
            }

            showLoading(false);
        }

       function actualizarDuracionPrecio(select) {
    const actoNombre = select.value;
    const acto = allData.actos.find(a => a[2] === actoNombre);  // Cambio aqu√≠
    
    if (acto) {
        const form = select.closest('form');
        form.duracion.value = acto[4];
        form.precio.value = acto[5];
    }
}

        // ================================================
        // GESTI√ìN DE PACIENTES
        // ================================================

function cargarTablaPacientes() {
    const tbody = document.querySelector('#pacientesTable tbody');
    tbody.innerHTML = allData.pacientes.map(p => {
        const estado = p[11] || 'Activo';  // Cambio de p[7] a p[11]
        const badgeClass = estado === 'Activo' ? 'badge-success' : 'badge-danger';
        
        return `
            <tr>
                <td>${p[1]}</td>
                <td>${p[2]}</td>
                <td>${p[3]}</td>
                <td>${p[4] || '-'}</td>
                <td>${p[5] || '-'}</td>
                <td><span class="badge ${badgeClass}">${estado}</span></td>
                <td class="actions">
                    <button class="btn btn-info btn-sm" onclick="verHistorial('${p[0]}')">Historial</button>
                    <button class="btn btn-warning btn-sm" onclick="editarPaciente('${p[0]}')">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="eliminarPaciente('${p[0]}')">Eliminar</button>
                </td>
            </tr>
        `;
    }).join('');
}
        async function guardarPaciente() {
            showLoading(true);
            const form = document.getElementById('pacienteForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                showLoading(false);
                return;
            }

            const valores = {
                values: [
                    'P' + Date.now(),
                    form.dni.value,
                    form.nombre.value,
                    form.apellidos.value,
                    form.fechaNacimiento.value || '',
                    form.telefono.value || '',
                    form.email.value || '',
                    'Activo',
                    form.direccion.value || '',
                    form.historial.value || '',
                    new Date().toISOString()
                ]
            };

            const success = await guardarDato('Pacientes', valores.values);

            if (success) {
                alert('Paciente guardado correctamente');
                closeModal('pacienteModal');
                form.reset();
                await cargarDatos();
                cargarTablaPacientes();
                poblarSelectsPacientes();
                actualizarDashboard();
            } else {
                alert('Error al guardar el paciente');
            }

            showLoading(false);
        }

        function filtrarPacientes() {
            const search = document.getElementById('searchPaciente').value.toLowerCase();
            const estado = document.getElementById('filtroPacienteEstado').value;
            
            const tbody = document.querySelector('#pacientesTable tbody');
            const pacientesFiltrados = allData.pacientes.filter(p => {
                const cumpleTexto = !search || 
                    p[1].toLowerCase().includes(search) || 
                    p[2].toLowerCase().includes(search) || 
                    p[3].toLowerCase().includes(search);
                const cumpleEstado = !estado || p[7] === estado;
                return cumpleTexto && cumpleEstado;
            });

            tbody.innerHTML = pacientesFiltrados.map(p => {
                const estadoPaciente = p[7] || 'Activo';
                const badgeClass = estadoPaciente === 'Activo' ? 'badge-success' : 'badge-danger';
                
                return `
                    <tr>
                        <td>${p[1]}</td>
                        <td>${p[2]}</td>
                        <td>${p[3]}</td>
                        <td>${p[5] || '-'}</td>
                        <td>${p[6] || '-'}</td>
                        <td><span class="badge ${badgeClass}">${estadoPaciente}</span></td>
                        <td class="actions">
                            <button class="btn btn-info btn-sm" onclick="verHistorial('${p[0]}')">Historial</button>
                            <button class="btn btn-warning btn-sm" onclick="editarPaciente('${p[0]}')">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarPaciente('${p[0]}')">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function eliminarPaciente(id) {
            const success = await eliminarDato('Pacientes', id);
            if (success) {
                alert('Paciente eliminado correctamente');
                await cargarDatos();
                cargarTablaPacientes();
                poblarSelectsPacientes();
            }
        }

        function verHistorial(id) {
            const paciente = allData.pacientes.find(p => p[0] === id);
            const citasPaciente = allData.citas.filter(c => c[3] === id);
            
            alert(`Historial de ${paciente[2]} ${paciente[3]}\n\nTotal de citas: ${citasPaciente.length}`);
        }

        // ================================================
        // GESTI√ìN DE PROFESIONALES
        // ================================================

        function cargarTablaProfesionales() {
            const tbody = document.querySelector('#profesionalesTable tbody');
            tbody.innerHTML = allData.profesionales.map(p => {
                const estado = p[8] || 'Activo';
                const badgeClass = estado === 'Activo' ? 'badge-success' : 'badge-danger';
                
                return `
                    <tr>
                        <td>${p[1]}</td>
                        <td>${p[2]}</td>
                        <td>${p[3]}</td>
                        <td>${p[4] || '-'}</td>
                        <td><span class="badge ${badgeClass}">${estado}</span></td>
                        <td class="actions">
                            <button class="btn btn-warning btn-sm" onclick="editarProfesional('${p[0]}')">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarProfesional('${p[0]}')">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function guardarProfesional() {
            showLoading(true);
            const form = document.getElementById('profesionalForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                showLoading(false);
                return;
            }

            const valores = {
                values: [
                    'PR' + Date.now(),
                    form.nombre.value,
                    form.email.value,
                    form.tipo.value,
                    form.especialidad.value || '',
                    form.telefono.value || '',
                    form.numColegiado.value || '',
                    '',
                    'Activo',
                    new Date().toISOString()
                ]
            };

            const success = await guardarDato('Profesionales', valores.values);

            if (success) {
                alert('Profesional guardado correctamente');
                closeModal('profesionalModal');
                form.reset();
                await cargarDatos();
                cargarTablaProfesionales();
                poblarSelectsProfesionales();
            } else {
                alert('Error al guardar el profesional');
            }

            showLoading(false);
        }

        async function eliminarProfesional(id) {
            const success = await eliminarDato('Profesionales', id);
            if (success) {
                alert('Profesional eliminado correctamente');
                await cargarDatos();
                cargarTablaProfesionales();
                poblarSelectsProfesionales();
            }
        }

        // ================================================
        // GESTI√ìN DE ACTOS
        // ================================================

        function cargarTablaActos() {
            const tbody = document.querySelector('#actosTable tbody');
            tbody.innerHTML = allData.actos.map(a => `
                <tr>
                    <td>${a[1]}</td>
                    <td>${a[2]}</td>
                    <td>${a[3]}</td>
                    <td>${a[4]}</td>
                    <td>${a[5]}‚Ç¨</td>
                    <td class="actions">
                        <button class="btn btn-warning btn-sm" onclick="editarActo('${a[0]}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarActo('${a[0]}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        async function guardarActo() {
            showLoading(true);
            const form = document.getElementById('actoForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                showLoading(false);
                return;
            }

            const valores = {
                values: [
                    'A' + Date.now(),
                    form.codigo.value,
                    form.nombre.value,
                    form.tipo.value,
                    form.duracion.value,
                    form.precio.value,
                    form.descripcion.value || '',
                    new Date().toISOString()
                ]
            };

            const success = await guardarDato('Actos', valores.values);

            if (success) {
                alert('Acto guardado correctamente');
                closeModal('actoModal');
                form.reset();
                await cargarDatos();
                cargarTablaActos();
                poblarSelectsActos();
            } else {
                alert('Error al guardar el acto');
            }

            showLoading(false);
        }

        async function eliminarActo(id) {
            const success = await eliminarDato('Actos', id);
            if (success) {
                alert('Acto eliminado correctamente');
                await cargarDatos();
                cargarTablaActos();
                poblarSelectsActos();
            }
        }

        // ================================================
        // GESTI√ìN DE FACTURAS
        // ================================================

        function cargarTablaFacturas() {
            const tbody = document.querySelector('#facturasTable tbody');
            tbody.innerHTML = allData.facturas.map(f => {
                const estado = f[9] || 'Pendiente';
                const badgeClass = estado === 'Pagada' ? 'badge-success' : 
                                  estado === 'Vencida' ? 'badge-danger' : 'badge-warning';
                
                return `
                    <tr>
                        <td>${f[1]}</td>
                        <td>${formatearFecha(f[2])}</td>
                        <td>${f[4]}</td>
                        <td>${f[5]}</td>
                        <td>${f[6]}‚Ç¨</td>
                        <td>${f[7]}%</td>
                        <td>${f[8]}‚Ç¨</td>
                        <td><span class="badge ${badgeClass}">${estado}</span></td>
                        <td class="actions">
                            <button class="btn btn-info btn-sm" onclick="verFactura('${f[0]}')">Ver</button>
                            <button class="btn btn-success btn-sm" onclick="marcarPagada('${f[0]}')">Pagada</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function guardarFactura() {
            showLoading(true);
            const form = document.getElementById('facturaForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                showLoading(false);
                return;
            }

            const paciente = allData.pacientes.find(p => p[0] === form.pacienteId.value);
            const numeroFactura = 'F' + new Date().getFullYear() + '-' + (allData.facturas.length + 1);

            const valores = {
                values: [
                    'FA' + Date.now(),
                    numeroFactura,
                    form.fecha.value,
                    form.pacienteId.value,
                    paciente ? `${paciente[2]} ${paciente[3]}` : '',
                    form.concepto.value,
                    form.base.value,
                    form.iva.value,
                    form.total.value,
                    'Pendiente',
                    '',
                    form.formaPago.value,
                    new Date().toISOString()
                ]
            };

            const success = await guardarDato('Facturas', valores.values);

            if (success) {
                alert('Factura guardada correctamente');
                closeModal('facturaModal');
                form.reset();
                await cargarDatos();
                cargarTablaFacturas();
                actualizarDashboard();
            } else {
                alert('Error al guardar la factura');
            }

            showLoading(false);
        }

        function calcularTotal() {
            const form = document.getElementById('facturaForm');
            const base = parseFloat(form.base.value) || 0;
            const iva = parseFloat(form.iva.value) || 0;
            const total = base + (base * iva / 100);
            form.total.value = total.toFixed(2);
        }

        function filtrarFacturas() {
            alert('Funci√≥n de filtrado en desarrollo');
        }

        function verFactura(id) {
            alert('Ver factura: ' + id);
        }

        async function marcarPagada(id) {
            const success = await actualizarDato('Facturas', id, { estado: 'Pagada', fechaCobro: new Date().toISOString() });
            if (success) {
                alert('Factura marcada como pagada');
                await cargarDatos();
                cargarTablaFacturas();
                actualizarDashboard();
            }
        }

        // ================================================
        // CONFIGURACI√ìN
        // ================================================

        function cargarConfiguracionEmpresa() {
            if (allData.empresa.length > 0) {
                const empresa = allData.empresa[0];
                document.getElementById('empresaNombre').value = empresa[1] || '';
                document.getElementById('empresaCIF').value = empresa[2] || '';
                document.getElementById('empresaDireccion').value = empresa[3] || '';
                document.getElementById('empresaCP').value = empresa[4] || '';
                document.getElementById('empresaCiudad').value = empresa[5] || '';
                document.getElementById('empresaProvincia').value = empresa[6] || '';
                document.getElementById('empresaTelefono').value = empresa[7] || '';
                document.getElementById('empresaEmail').value = empresa[8] || '';
                document.getElementById('empresaWeb').value = empresa[9] || '';
                document.getElementById('empresaIVA').value = empresa[10] || '21';
                document.getElementById('empresaFormaPago').value = empresa[11] || 'Efectivo';
                document.getElementById('empresaObservaciones').value = empresa[12] || '';
            }
        }

        async function guardarEmpresa(e) {
            e.preventDefault();
            showLoading(true);
            
            const form = document.getElementById('empresaForm');
            
            const valores = {
                values: [
                    'EMP001',
                    form.empresaNombre.value,
                    form.empresaCIF.value,
                    form.empresaDireccion.value,
                    form.empresaCP.value,
                    form.empresaCiudad.value,
                    form.empresaProvincia.value,
                    form.empresaTelefono.value,
                    form.empresaEmail.value,
                    form.empresaWeb.value,
                    form.empresaIVA.value,
                    form.empresaFormaPago.value,
                    form.empresaObservaciones.value,
                    new Date().toISOString()
                ]
            };

            let success;
            if (allData.empresa.length > 0) {
                success = await actualizarDato('Empresa', 'EMP001', valores.values);
            } else {
                success = await guardarDato('Empresa', valores.values);
            }

            if (success) {
                alert('Configuraci√≥n guardada correctamente');
                await cargarDatos();
            } else {
                alert('Error al guardar la configuraci√≥n');
            }

            showLoading(false);
        }

        function cargarTablaUsuarios() {
            const tbody = document.querySelector('#usuariosTable tbody');
            tbody.innerHTML = allData.usuarios.map(u => {
                const estado = u[8] || 'Activo';
                const badgeClass = estado === 'Activo' ? 'badge-success' : 'badge-danger';
                
                return `
                    <tr>
                        <td>${u[0]}</td>
                        <td>${u[1]}</td>
                        <td>${u[2]}</td>
                        <td>${u[4]}</td>
                        <td><span class="badge ${badgeClass}">${estado}</span></td>
                        <td class="actions">
                            <button class="btn btn-warning btn-sm" onclick="editarUsuario('${u[0]}')">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarUsuario('${u[0]}')">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function guardarUsuario() {
            showLoading(true);
            const form = document.getElementById('usuarioForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                showLoading(false);
                return;
            }

            const valores = {
                values: [
                    'U' + Date.now(),
                    form.nombre.value,
                    form.email.value,
                    form.password.value,
                    form.tipo.value,
                    '',
                    '',
                    '',
                    'Activo',
                    new Date().toISOString()
                ]
            };

            const success = await guardarDato('Usuarios', valores.values);

            if (success) {
                alert('Usuario guardado correctamente');
                closeModal('usuarioModal');
                form.reset();
                await cargarDatos();
                cargarTablaUsuarios();
            } else {
                alert('Error al guardar el usuario');
            }

            showLoading(false);
        }

        async function eliminarUsuario(id) {
            if (id === currentUser.id) {
                alert('No puedes eliminar tu propio usuario');
                return;
            }
            
            const success = await eliminarDato('Usuarios', id);
            if (success) {
                alert('Usuario eliminado correctamente');
                await cargarDatos();
                cargarTablaUsuarios();
            }
        }

        async function guardarHorarios(e) {
            e.preventDefault();
            showLoading(true);
            
            const form = document.getElementById('horariosForm');
            
            const valores = {
                values: [
                    form.horarioProfesional.value,
                    form.horarioLunes.value || '',
                    form.horarioMartes.value || '',
                    form.horarioMiercoles.value || '',
                    form.horarioJueves.value || '',
                    form.horarioViernes.value || '',
                    form.horarioSabado.value || '',
                    form.horarioDomingo.value || '',
                    new Date().toISOString()
                ]
            };

            const success = await guardarDato('Horarios', valores.values);

            if (success) {
                alert('Horarios guardados correctamente');
                form.reset();
                await cargarDatos();
            } else {
                alert('Error al guardar los horarios');
            }

            showLoading(false);
        }

        // ================================================
        // EXPORTACI√ìN
        // ================================================

        function exportarPacientes() {
            const fechaDesde = document.getElementById('exportFechaDesde').value;
            const fechaHasta = document.getElementById('exportFechaHasta').value;
            
            let pacientes = allData.pacientes;
            
            if (fechaDesde || fechaHasta) {
                pacientes = pacientes.filter(p => {
                    const fecha = new Date(p[10]);
                    if (fechaDesde && fecha < new Date(fechaDesde)) return false;
                    if (fechaHasta && fecha > new Date(fechaHasta)) return false;
                    return true;
                });
            }

            exportarAExcel(pacientes, 'Pacientes');
        }

        function exportarCitas() {
            const fechaDesde = document.getElementById('exportFechaDesde').value;
            const fechaHasta = document.getElementById('exportFechaHasta').value;
            
            let citas = allData.citas;
            
            if (fechaDesde || fechaHasta) {
                citas = citas.filter(c => {
                    if (fechaDesde && c[1] < fechaDesde) return false;
                    if (fechaHasta && c[1] > fechaHasta) return false;
                    return true;
                });
            }

            exportarAExcel(citas, 'Citas');
        }

        function exportarFacturacion() {
            const fechaDesde = document.getElementById('exportFechaDesde').value;
            const fechaHasta = document.getElementById('exportFechaHasta').value;
            
            let facturas = allData.facturas;
            
            if (fechaDesde || fechaHasta) {
                facturas = facturas.filter(f => {
                    if (fechaDesde && f[2] < fechaDesde) return false;
                    if (fechaHasta && f[2] > fechaHasta) return false;
                    return true;
                });
            }

            exportarAExcel(facturas, 'Facturacion');
        }

        function exportarAExcel(data, nombre) {
            let csv = '';
            data.forEach(row => {
                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', nombre + '_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ================================================
        // FUNCIONES AUXILIARES
        // ================================================

        function poblarSelectsPacientes() {
    const selects = document.querySelectorAll('select[name="pacienteId"]');
    const options = allData.pacientes
        .filter(p => p[11] === 'Activo')  // Cambio de p[7] a p[11]
        .map(p => `<option value="${p[0]}">${p[2]} ${p[3]} (${p[1]})</option>`)
        .join('');
    
    selects.forEach(select => {
        const defaultOption = select.querySelector('option[value=""]');
        select.innerHTML = defaultOption ? defaultOption.outerHTML + options : options;
    });
}

        function poblarSelectsProfesionales() {
            const selects = document.querySelectorAll('select[name="profesional"], #horarioProfesional');
            const options = allData.profesionales
                .filter(p => p[8] === 'Activo')
                .map(p => `<option value="${p[1]}">${p[1]} - ${p[4] || p[3]}</option>`)
                .join('');
            
            selects.forEach(select => {
                const defaultOption = select.querySelector('option[value=""]');
                select.innerHTML = defaultOption ? defaultOption.outerHTML + options : options;
            });
        }

        function poblarSelectsActos() {
            const selects = document.querySelectorAll('select[name="acto"]');
            const options = allData.actos
                .map(a => `<option value="${a[2]}" data-duracion="${a[4]}" data-precio="${a[5]}">${a[2]} (${a[4]}min - ${a[5]}‚Ç¨)</option>`)
                .join('');
            
            selects.forEach(select => {
                const defaultOption = select.querySelector('option[value=""]');
                select.innerHTML = defaultOption ? defaultOption.outerHTML + options : options;
            });
        }

        function poblarFiltroProfesionales() {
            const select = document.getElementById('filtroProfesional');
            const options = allData.profesionales
                .filter(p => p[8] === 'Activo')
                .map(p => `<option value="${p[1]}">${p[1]}</option>`)
                .join('');
            
            select.innerHTML = '<option value="">Todos</option>' + options;
        }

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
    
    // Poblar selectores seg√∫n el modal
    if(modalId === 'citaModal') {
        poblarSelectsPacientes();
        poblarSelectsProfesionales();
        poblarSelectsActos();
    } else if(modalId === 'facturaModal') {
        poblarSelectsPacientes();
    }
}        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function showAlert(message, type, elementId) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type} active`;
            alert.textContent = message;
            
            setTimeout(() => {
                alert.classList.remove('active');
            }, 5000);
        }

        function formatearFecha(fecha) {
            if (!fecha) return '-';
            const [year, month, day] = fecha.split('-');
            return `${day}/${month}/${year}`;
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>
